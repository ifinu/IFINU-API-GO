# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COMANDOS PARA EXECUTAR NO SERVIDOR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# PASSO 1: Conecte no servidor
# ssh mpx@192.168.0.100
# Senha: Theo231023@
#
# PASSO 2: Copie e cole TODO este bloco de uma vez:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Parar Java e liberar porta
echo "ğŸ›‘ [1/8] Parando Java Spring Boot..."
docker stop ifinu-api-java 2>/dev/null || true
docker rm ifinu-api-java 2>/dev/null || true
docker stop ifinu-api 2>/dev/null || true
docker rm ifinu-api 2>/dev/null || true
echo "âš”ï¸  [2/8] Liberando porta 8080..."
lsof -t -i:8080 | xargs kill -9 2>/dev/null || true
echo "âœ… Java parado e porta liberada"

# Clonar/Atualizar repositÃ³rio Go
echo "ğŸ“¦ [3/8] Configurando repositÃ³rio Go..."
if [ ! -d "/home/mpx/ifinu-api-go" ]; then
    cd /home/mpx
    git clone https://github.com/ifinu/IFINU-API-GO.git ifinu-api-go
    echo "âœ… RepositÃ³rio clonado"
else
    cd /home/mpx/ifinu-api-go
    git fetch origin
    git reset --hard origin/main
    echo "âœ… RepositÃ³rio atualizado"
fi
cd /home/mpx/ifinu-api-go

# Verificar/criar .env
echo "ğŸ”§ [4/8] Verificando .env..."
if [ ! -f ".env" ]; then
    cp .env.example .env
    echo "âš ï¸  .env criado - VOCÃŠ PRECISA CONFIGURÃ-LO!"
    echo "Execute: nano .env"
    echo "Pressione CTRL+X para continuar este script"
else
    echo "âœ… .env jÃ¡ existe"
fi

# Build da imagem
echo "ğŸ”¨ [5/8] Buildando imagem Docker..."
docker build -t ifinu-api-go:latest .
echo "âœ… Imagem buildada"

# Limpar imagens antigas
echo "ğŸ§¹ [6/8] Limpando imagens antigas..."
docker image prune -f
echo "âœ… Limpeza concluÃ­da"

# Executar container
echo "ğŸš€ [7/8] Iniciando container..."
docker run -d \
  -p 8080:8080 \
  --name ifinu-api \
  --restart unless-stopped \
  --env-file .env \
  ifinu-api-go:latest
echo "âœ… Container iniciado"

# Verificar
echo "ğŸ’š [8/8] Verificando deploy..."
sleep 5
docker ps | grep ifinu-api
echo ""
echo "Health check:"
curl -s http://localhost:8080/health | jq '.' || curl -s http://localhost:8080/health
echo ""
echo "Logs:"
docker logs --tail 20 ifinu-api

# Resumo
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘              âœ… DEPLOY CONCLUÃDO COM SUCESSO              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“Š InformaÃ§Ãµes:"
echo "  URL: http://192.168.0.100:8080"
echo "  Health: http://192.168.0.100:8080/health"
echo "  Container: ifinu-api"
echo ""
echo "ğŸ“‹ Comandos Ãºteis:"
echo "  Ver logs: docker logs -f ifinu-api"
echo "  Parar: docker stop ifinu-api"
echo "  Reiniciar: docker restart ifinu-api"
echo ""
echo "ğŸ‰ API IFINU GO estÃ¡ rodando!"
echo "ğŸ—‘ï¸  Backend Java foi parado"
