name: Deploy IFINU API GO

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy para VPS
    runs-on: self-hosted

    steps:
      - name: Deploy API
        run: |
          echo "ğŸ“¥ Atualizando cÃ³digo e fazendo deploy..."
          cd /opt/ifinu/api
          git fetch origin
          git reset --hard origin/main
          git pull origin main

          echo "ğŸ”¨ Rebuilding API..."
          cd /opt/ifinu
          docker compose build api

          echo "ğŸš€ Reiniciando API..."
          docker compose up -d api

          echo "â³ Aguardando inicializaÃ§Ã£o..."
          sleep 10

          echo "ğŸ’š Testando health check..."
          curl -f http://localhost:8080/health || exit 1

          echo "ğŸ“‹ Logs da API:"
          docker logs --tail 20 ifinu-api

          echo ""
          echo "âœ… Deploy successful!"
