name: Deploy IFINU API GO

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy para VPS
    runs-on: self-hosted

    steps:
      - name: Checkout c√≥digo
        run: |
          echo "üì• Atualizando c√≥digo no VPS..."
          cd /opt/ifinu/api
          git fetch origin
          git reset --hard origin/main
          git pull origin main

      - name: Deploy via Docker Compose
        run: |
          echo "üî® Rebuilding e reiniciando API..."
          cd /opt/ifinu
          docker compose build api
          docker compose up -d api

      - name: Aguardar inicializa√ß√£o
        run: |
          echo "‚è≥ Aguardando API inicializar..."
          sleep 10

      - name: Health check
        run: |
          echo "üíö Testando health check..."
          curl -f http://localhost:8080/health || exit 1
          echo ""
          echo "‚úÖ Deploy successful!"

      - name: Show logs
        if: always()
        run: |
          echo "üìã √öltimos logs da API:"
          docker logs --tail 20 ifinu-api
